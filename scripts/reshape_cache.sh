#!/bin/bash
doc="
Change CLiMAF cache tree structure from abcde/fghij/klmno/p... to ab/cdefghijklmnop...
Should be used only after definitively moving to a CliMAF version handling both structures 
(i.e. > 1.2.12)
Must be run in the cache directory, or have CLIMAF_CACHE set
Will save ~90% of i-nodes used
"

echo "Reshaping your CliMAF cache directory"

if [ $(ls ?????/?????/?????/????? 2>/dev/null | wc -l) -lt 5 ] ; then
    if [ "$CLIMAF_CACHE" ] ; then
	echo "Changing directory to CLIMAF_CACHE ($CLIMAF_CACHE) "
	cd $CLIMAF_CACHE
    else
	echo "Please check you run this script in a CliMAF cache directory"
	echo "This doesn't look to be the case (or reshaping was already done in $(pwd))"
	exit
    fi
fi

if [ $(ls ??/??????????????????????????????????????????????????????.nc | wc -l) -gt 5 ]; then
    echo "This Climaf cache dir was alreay reshaped. "
    exit
fi

#
echo -n "Finding and moving files : "
find . -type f -exec ls -s {} \; |
 while read size path ; do
    echo -n "."
    if [ ${path:4:1} != "/" ] ; then 
	b=${path//\//} ;
	dir=${b:1:2}
	mkdir -p $dir
	mv $path ./$dir/${b:3}
    fi
 done
echo "Deleting empty old_style directories"
rmdir -f --ignore-fail-on-non-empty -p ?????/?????/?????/?????/?????/?????/?????/?????/?????/?????
rmdir -f --ignore-fail-on-non-empty -p ?????/?????/?????/?????/?????/?????/?????/?????/?????/?????/?????
rmdir -f --ignore-fail-on-non-empty -p ?????/?????/?????/?????/?????/?????
#
echo "Done. Remember you must now use a CliMAF version > 1.2.12 for reaching these cache files"
